import mlflow
import transformers
import os
import openai
import pandas as pd
import dagshub
import rouge_score
import evaluate
import torch
import nltk
import textstat
import os
from dotenv import load_dotenv

load_dotenv()

os.environ.get("OPENAI_API_KEY")


#dagshub.init(repo_owner='harisgenai1', repo_name='LLMeval', mlflow=True)

#mlflow.set_tracking_uri("https://dagshub.com/harisgenai1/LLMeval.mlflow")

eval_data = pd.DataFrame(
    {
        "inputs": [
            "@entity0 has revealed he is loving life in @entity2 with @entity3 ahead of playing for @entity4 against @entity5 at his club 's home on sunday . the two @entity10 nations come together at the @entity11 in an international friendly , and @entity0 is delighted to be playing in the country he calls home after his £ 35million move from @entity16 last summer . and having made a lightning - quick start to his @entity19 career , @entity0 feels he is now well adapted to the ways of the @entity2 top flight . @entity0 has revealed that he is enjoying life in @entity23 ahead of facing @entity5 with @entity4 on sunday the @entity3 forward has adapted well to life in the @entity19 after his summer move from @entity16 @entity4 have been training at @entity3 's @entity28 base ahead of their game at the @entity11 ' i 'm well adapted to the country and the league now . i must keep on learning , though , ' he said . ' i want to expand my knowledge of @entity2 football in general , and @entity3 and my team - mates in particular . ' but overall i love this league . at the end of the day , football was invented in this country , right ? i live where football was invented . that makes me really happy . ' @entity0 made a lightning - quick start to his @entity19 career and says he is adapted to the country @entity0 controls the ball ahead of @entity46 's @entity45 during @entity3 's win at @entity48.@entity0 faces @entity5 with @placeholder at the @entity11 on sunday.@entity4 @entity3:Arsenal @entity2:England @entity0:Sanchez @entity11:Emirates Stadium @entity5:Brazil @entity10:South American @entity28:London Colney @entity4:Chile @entity23:London @entity19:Premier League @entity45:Yoan Gouffran @entity46:Newcastle @entity48:St James Park @entity16:Barcelona",

            "@entity0 showed he was back in a familiar place on tuesday ahead of @entity3 's clash with @entity4 in the @entity6 last - 16 second leg on wednesday night . @entity0 returns to @entity7 having played there between 2011 and 2014 , and is looking to spoil his former club 's chances of reaching the next round . the @entity13 defender posted a photograph on his @entity15 and wrote : ' right time to be back ! # @entity17 ' . @entity0 posted this on @entity15 ahead of @entity3 's clash with @entity4 in the @entity6 last - 16 @entity0 moved to @entity3 from @entity4 in 2014 for £ 50million but will hope to get the better of his former club @entity3 are in town to face @entity23 leaders @entity4 as they go head to head in the @entity6 @entity0 posted the snap after warning @entity4 they wo n't achieve success by simply sitting back when the two sides meet . the first leg of the @entity6 tie ended 1 - 1 , meaning a goalless draw would be enough to send @entity33 's side through to the next round . but @entity0 feels it would be foolish of his old club to invite pressure on themselves , considering the strength of the @entity41 champions ' attacking options . ' i know how @entity33 ( @entity33 ) will prepare for this , he will be telling the boys to be patient and hit us on the counter attack , ' @entity0 told @entity47 . ' he knows that we need to score and that they do n't , i know that is his way . we must be careful because i know that @entity4 have the ability to hurt on the counter attack , but they must be careful as well . ' to sit back and just defend against @entity53 ( @entity53 ) , ( @entity55 ) @entity54 and ( @entity57 ) @entity56 can also be very dangerous , so it is not just us who have to be careful . ' @entity0 spent three years in west @entity60 before his £ 50m summer transfer to the @entity63 champions.@entity4 face @placeholder at home in @entity6 last - 16 second leg @entity3.@entity3:PSG @entity17:LondonCity  @entity15:Instagram @entity0:Luiz @entity13:Brazil @entity6:Champions League @entity4:Chelsea @entity23:Premier League @entity33:Mourinho @entity53:Ibrahimovic @entity47:The Mirror @entity57:Ezequiel @entity41:Ligue 1 @entity55:Edinson @entity54:Cavani @entity7:Stamford Bridge @entity63:French @entity60:London @entity56:Lavezzi",

            "an @entity1 athlete who killed himself was found by a neuropathologist to have suffered from concussions but did not show evidence of chronic brain damage . wrestler and football player @entity6 , 22 , had been missing for several days when his body was found in a trash bin with a handgun near his right hand in @entity12 on november 30 . coroner dr @entity13 waited for neuropathology reports about @entity6 's brain before reaffirming in a final report issued on friday that he died from a gunshot to the head . an @entity1 athlete ( @entity6 pictured above ) who killed himself has had his death ruled a suicide after a neuropathologist found he had suffered from concussions but did not show evidence of chronic brain damage wrestler and football player @entity6 , 22 , had been missing for several days when his body was found in a trash bin with a handgun near his right hand in @entity12 on november 30 ( pictured above with his family ) coroner dr @entity13 waited for neuropathology reports about @entity30 's ( pictured right ) brain before reaffirming in a final report on friday that he died from a gunshot wound to the head @entity36 dr @entity35 from @entity37 said there was evidence of prior concussive injury , according to the @entity41 . however , @entity6 was not found to have chronic traumatic encephalopathy ( @entity43 ) , a condition which results from continuous head trauma . @entity43 can only be diagnosed after death and symptoms include depression , confusion and anger issues , according to @entity51 in january , @entity52 had ruled the athlete 's death a suicide . @entity36 dr @entity35 from @entity37 said there was evidence of prior concussive injury . however , @entity6 was not found to have chronic traumatic encephalopathy ( @entity43 ) , which results from continuous head trauma investigators concluded that @entity6 and his girlfriend broke up around the time he disappeared on november 26 investigators concluded that @entity6 and his girlfriend broke up around the time he disappeared on november 26 . the senior defensive tackle was last been seen at his apartment in @entity12 , when his roommates said he left to go on a walk . @entity6 texted his girlfriend after 1am that day , saying he loved her and wanted to talk , according to text records released by police this year . when he received responses asking him not to speak again to her , he replied , ' i am gon na kill myself , ' and he said that she should not go to his funeral , according to records . texts sent to his mother , @entity75 moments later said concussions were affecting his mind and he hoped he was not an embarrassment . texts sent to his mother , @entity75 moments later said concussions were affecting his mind and he hoped he was not an embarrassment ( above scenes near the dumpster where @entity6 's body was found last november ) @entity6 's body was discovered not far from his campus - area apartment by a woman and her son apparently were looking for items in the dumpster when they found the body she told police she received a text from her son around 1.30am on that said : ' i am sorry if i am an embarrassment but these concussions have my head all f * * * ed up . ' @entity6 's mother told police he had had several concussions and a few spells of extreme confusion . he was discovered not far from his campus - area apartment by a woman and her son apparently were looking for items in the dumpster when they found the body . dr @entity110 , chairman of psychiatry at @entity112 , who has studied concussions in college athletes , said that brain injuries seem to increase the likelihood of depression . if the person had depression or an anxiety disorder in the past , ' it often is the case that the concussion seems to exacerbate it , ' he said . ' these injuries do n't occur in a vacuum . people bring their own past history ... into the injury . 'coroner dr @entity13 ruled @placeholder 's death as suicide in january and reaffirmed it following @entity141 's tests in final report on friday.@entity6.@entity30:Karageorge @entity1:Ohio State @entity13:Anahi Ortiz @entity6:Karageorge @entity37:Ohio State University @entity36:Neuropathologist @entity43:CTE @entity52:Ortiz @entity51:Cleveland.com @entity41:Columbus Dispatch @entity12:Columbus @entity110:Tom McAllister @entity75:Susan Karageorge @entity35:Norman Lehman @entity112:Indiana University @entity133:Ohio @entity141:Lehman"

            ,

            "@entity0 : linked to ten shootings and two murders before he was shot and killed by police while travelling in a minicab violent gangster @entity0 – whose death sparked the 2011 riots – was holding a gun when a police marksman opened fire , a report concluded yesterday . an exhaustive three - and - a - half year investigation by the police watchdog completely exonerated the firearms officer who shot @entity16 of any wrongdoing . the 500 - page report concluded that the marksman , known only as @entity20 , used ‘ reasonable and proportionate force ’ and said that there is no ‘ reliable evidence ’ to undermine his account . and it backed @entity20 ’s version of events : that he shot @entity16 because he saw a gun and thought the gangster was about to open fire . last year an inquest ruled that @entity16 was lawfully killed – but the jury concluded that he had dropped the gun some time before he was shot . however , yesterday ’s report by the @entity35 said the gangster was holding the gun and was ‘ in the process of throwing it to his right as he was shot ’ . the @entity35 said it based its conclusions on the evidence from the inquest and extra evidence which it obtained later . in the aftermath of @entity16 ’s death , supposed witnesses claimed they saw police marksmen shoot him after he had already given himself up . one claimed she saw police officers plant a gun at the scene minutes after the shooting . all of these accounts were rejected by the @entity35 because the accounts were riddled with inconsistencies . the investigation also rejected claims made by @entity16 ’s mother @entity59 and girlfriend @entity60 that officers tampered with evidence and lied in their witness statements . before his death , @entity16 , 29 , was considered to be one of @entity67 ’s most violent gangsters who was linked to ten shootings and two murders . aftermath : @entity16 's body lies in the street moments after he was killed . a report today ruled that he had run from the minicab holding the gun wrapped in a sock , at which point officers opened fire he was placed under surveillance in august 2011 after officers learnt he was about to pick up a gun from @entity84 , an associate , in @entity85 , east @entity86 . after @entity16 had collected the weapon , the minicab in which he was travelling was stopped by armed police during the evening rush - hour in @entity91 , north @entity86 . the @entity35 rejected wild conspiracy theories and inaccurate witness statements , which were promoted by @entity0 ’s supporters . the father - of - four , who had taken the party drug ecstasy , then ran out of the @entity99 minicab holding the gun , the report said . @entity16 was shot twice by @entity20 after the officer saw him raise a gun wrapped in a sock towards him . one bullet hit the gangster in his right bicep and the other hit him in the chest . when stopped by police he was carrying a @entity111 starter pistol that had been converted into a ‘ lethal ’ handgun capable of firing 9mm bullets . the marksman has repeatedly said that it was his ‘ honestly held belief ’ that @entity16 was about to shoot him and his colleagues . ‘ the world just stopped in my head , ’ he told the inquest . ‘ it ’s like a freeze frame moment . the only thing i was focusing on is the gun . ’ @entity16 ’s death triggered four days of rioting and looting across @entity127 , leading to five deaths and £ 200million of damage . more than 1,400 were later jailed over the riots . the @entity35 report found that @entity133 ’s decision to place @entity16 under surveillance was ‘ logical and legitimate ’ because he was ‘ coming to prominence ’ as an active member of the notorious @entity138 gang . it also said that undercover officers were right to stop @entity16 when he was in the minicab . after studying more than 1,200 documents , 500 witness statements and 340 exhibits , it found ‘ no indication of misconduct for any armed officer involved ’ . but it recommended that police forces should use audio and video equipment to record undercover operations so they can provide an ‘ accurate and incontrovertible ’ record of what happened . @entity35 deputy chairman @entity155 said : ‘ our findings are based on the best available evidence , checked and cross-checked . ’ last night , the @entity16 family released a statement in which they claimed the report ‘ confirms their belief that the @entity35 are unfit for purpose ’ . the family described the watchdog ’s conduct as ‘ a chronicle of inefficiency and incompetence ’ .@entity0 , 29 , was shot twice during rush hour in @placeholder in 2011 .@entity91 @entity16:Duggan @entity20:V53 @entity0:Mark Duggan @entity35:IPCC @entity86:London @entity133:Scotland Yard @entity60:Precious Douaihy @entity84:Kevin Hutchinson-Foster @entity85:Leyton @entity99:Toyota @entity67:Britain @entity127:England @entity59:Pamela @entity111:BBM Bruni @entity155:Rachel Cerfontyne @entity91:Tottenham @entity138:Tottenham ManDem",

            "former @entity1 boss @entity0 has turned up the heat on successor @entity3 by claiming the @entity4 should be winning a trophy every year . @entity0 thinks @entity3 was ' really lucky ' to inherit a strong side from him and he should be delivering continual success at the @entity8 . but @entity3 , who did win two trophies last season , is now under heavy pressure with @entity1 faltering in their @entity13 title defence and facing an uphill task against @entity15 in the @entity16 . @entity3 is under pressure to save @entity1 's season and his job as well @entity3 has come under fire for @entity1 's faltering title defence and @entity16 campaign @entity1 will look to overturn a 201 first - leg deficit against @entity15 in their @entity16 tie @entity0 , who was sacked by @entity1 in 2013 despite winning the @entity13 title the previous year , told @entity25 : ' i think @entity3 was really lucky because he got this team that is a strong team and he has a chance to put in more good players . ' i think @entity1 can win a title every year and have a chance - it should and must try to win a title every year . ' @entity0 's jibe came on the eve of the second leg of @entity1 's last - 16 @entity16 tie at @entity15 , which they will go into trailing 2 - 1 . @entity0 guided @entity1 to the @entity13 title in 2012 after @entity39 success in 2011 @entity0 lost his job at @entity1 in 2013 after his team 's failed title defence and poor @entity44 showing the success or otherwise of @entity1 's season now appears to hinge on the outcome at the @entity48 as , trailing @entity49 by six points having played a game more , the @entity13 looks beyond them . but @entity0 said : ' it 's my opinion that @entity1 is the best team in the @entity13 . it 's in second and six points behind @entity49 but i think it 's the best team . ' in the @entity13 anything can happen right up to the last game , in the last minute . i think they should think that they have a chance to win the title . ' @entity64 does n't fear for @entity1 job.@placeholder turns up the heat on @entity3 @entity0 .@entity3:Pellegrini @entity16:Champions League @entity1:City @entity0:Mancini @entity13:Premier League @entity4:Chilean @entity39:FA Cup @entity8:Etihad Stadium @entity15:Barcelona @entity44:European @entity69:Italian @entity64:VIDEO Pellegrini @entity25:CNN @entity48:Nou Camp @entity49:Chelsea",


        ],
        "ground_truth": [
            "Arsenal star Alexis Sanchez reveals his love for life in England ahead of facing Brazil",

            "David Luiz back in London as former Chelsea defender posts Instagram photo ahead of visit to Stamford Bridge with PSG in Champions League last-16 second leg ",

            "Ohio State footballer who shot himself dead in a dumpster because he feared concussions made him an 'embarrassment' showed 'no evidence chronic brain damage",

            "Police marksman vindicated over shooting Mark Duggan: Fleeing gangster whose death sparked London riots was holding a gun when officer killed him",

            "Roberto Mancini says that Manuel Pellegrini should be winning a trophy every year at Manchester City and he was 'really lucky' to inherit a strong team from him",

        ],
    }
)

#mlflow.set_experiment("LLM Evaluation")

with mlflow.start_run() as run:
    system_prompt = "Answer the following question in two sentences"
    # Wrap "gpt-4" as an MLflow model.
    logged_model_info = mlflow.openai.log_model(
        model="gpt-3.5-turbo-0125",
        task=openai.chat.completions,
        artifact_path="model",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": "{question}"},
        ],
    )

    # Use predefined question-answering metrics to evaluate our model.
    results = mlflow.evaluate(
        logged_model_info.model_uri,
        eval_data,
        targets="ground_truth",
        model_type="text-summarization",
    )
    print(f"See aggregated evaluation results below: \n{results.metrics}")

    # Evaluation result for each data record is available in `results.tables`.
    eval_table = results.tables["eval_results_table"]
    df=pd.DataFrame(eval_table)
    df.to_csv('evall.csv')
    print(f"See evaluation table below: \n{eval_table}")